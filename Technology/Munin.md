# Munin 2.06 Install&Analysis
<!-- toc -->
### Munin install
  OS: Ubuntu 12.04 LTS  
  Web server : Apache2 or Nginx
### munin-node
> sudo apt-get install munin-node <br>
> sudo vi /etc/munin/munin-node.conf

	allow ^172\.26\..*$
	allow ^172\.26\.183\.77*$ # ip addr of munin master
    
### munin
**Adding Debian Backport Repository**

Create and edit /etc/apt/sources.list.d/backports.list and add:

	sudo vi /etc/apt/sources.list.d/backports.list
	# add deb http://backports.debian.org/debian-backports squeeze-backports main

Update your repositories:

	# apt-get update

and finally, install Munin from the squeeze-backports:

	# apt-get install munin -t squeeze-backports

**Append settings to end of /etc/munin/munin.conf**

	# chown -R munin:munin follow directories
	dbdir /var/lib/munin
	htmldir /var/cache/munin/www
	logdir /var/log/munin
	rundir  /var/run/munin
	# add
	html_strategy cgi
	graph_strategy cgi
	cgiurl_graph /munin-cgi/munin-cgi-graph
	
	
**sudo vi /etc/munin/apache.conf <br> 
  sudo cp /etc/munin/apache.conf /etc/apache2/conf.d/munin**

	Alias /munin /var/cache/munin/www
	<Directory /var/cache/munin/www>
	    Order allow,deny
	    # Allow from localhost 127.0.0.0/8 ::1
	    Allow from all
		[...]
	</Directory>


	ScriptAlias /munin-cgi/munin-cgi-graph /usr/lib/munin/cgi/munin-cgi-graph
	<Location /munin-cgi/munin-cgi-graph>
        Order allow,deny
        #Allow from localhost 127.0.0.0/8 ::1
        Allow from all  # enable outside browser could show dynamic image
		[...]
	</Location>

	ScriptAlias /munin-cgi/munin-cgi-html /usr/lib/munin/cgi/munin-cgi-html
	<Location /munin-cgi/munin-cgi-html>
        Order allow,deny
        # Allow from localhost 127.0.0.0/8 ::1
        Allow from all
		[...]
	</Location>

**Important**

> The FastCGI processes will log to "/var/log/munin/munin-cgi-graph.log" and "/var/log/munin/munin-cgi-html.log".
> 
> Note that these run with the web server's permissions, unless specified otherwise. If the web server does not have write access to the specific log files (or access to the directory they are in), the cgi processes will hang, and not produce any output.

	sudo chmod o+r /var/log/munin/munin-cgi-graph.log
	sudo chmod o+r /var/log/munin/munin-cgi-html.log

###Apache2

**/etc/apache2/apache2.conf**

	# Include generic snippets of statements
	Include conf.d/ # conf.d/munin is auto-generated by munin
	
	# Include the virtual host configurations:
	Include sites-enabled/ # could log off

	# ------------ follow is added by dan ------------------
	# Enable this for template generation
	Alias /munin /var/cache/munin/www
	
	# Enable this for cgi-based templates
	Alias /munin-cgi/static /var/cache/munin/www/static
	ScriptAlias /munin-cgi/munin-cgi-graph /usr/lib/munin/cgi/munin-cgi-graph
	ScriptAlias /munin-cgi /usr/lib/munin/cgi/munin-cgi-html
	
	<Directory /var/cache/munin/www>
	        Order allow,deny
	        Allow from all
	        Options None
	
	    <IfModule mod_expires.c>
	        ExpiresActive On
	        ExpiresDefault M310
	    </IfModule>
	
	</Directory>
	
	# Enables fastcgi for munin-cgi-html if present
	<Location /munin-cgi>
	    <IfModule mod_fastcgi.c>
	        SetHandler fastcgi-script
	    </IfModule>
	</Location>
	
	<Location /munin-cgi/static>
	        SetHandler None
	</Location>
	
	# Enables fastcgi for munin-cgi-graph if present
	<Location /munin-cgi/munin-cgi-graph>
	        <IfModule mod_fastcgi.c>
	                SetHandler fastcgi-script
	        </IfModule>
	</Location>
	
	<Location /munin-cgi/munin-cgi-html>
	        <IfModule mod_fastcgi.c>
	                SetHandler fastcgi-script
	        </IfModule>
	</Location>
	# ===============================================

**add virtualhost**


> edit /etc/apache2/site-available/munitor.com

	<VirtualHost *:80>
	    ServerName munitor.com
	    ServerAlias www.munitor.com
	    ServerAdmin  danster@qq.com
	
	        DocumentRoot /var/cache/munin/www
	        ScriptAlias /munin-cgi/munin-cgi-graph /usr/lib/munin/cgi/munin-cgi-graph
	        ScriptAlias /munin-cgi /usr/lib/munin/cgi/munin-cgi-html
	
	        <Directory /var/cache/munin/www>
	                    Order allow,deny
	                    Allow from all
	                    Options None
	
	                <IfModule mod_expires.c>
	                    ExpiresActive On
	                        ExpiresDefault M310
	                </IfModule>
	
	        </Directory>
	
	        # Enables fastcgi for munin-cgi-html if present
	        <Location /munin-cgi>
	                <IfModule mod_fastcgi.c>
	                    SetHandler fastcgi-script
	                </IfModule>
	        </Location>
	
	        <Location /munin-cgi/static>
	                SetHandler None
	        </Location>
	
	        # Enables fastcgi for munin-cgi-graph if present
	        <Location /munin-cgi/munin-cgi-graph>
	                    <IfModule mod_fastcgi.c>
	                            SetHandler fastcgi-script
	                    </IfModule>
	        </Location>
	
	        <Location /munin-cgi/munin-cgi-html>
	                    <IfModule mod_fastcgi.c>
	                            SetHandler fastcgi-script
	                    </IfModule>
	        </Location>
	
	</VirtualHost>

> enable virtual host 

	sudo a2ensite munitor.com # sudo a2dissite munitor.com
	add Include sites-enabled/ in /etc/apache2/apache2.conf
	sudo service apache2 reload

>  /etc/apache2/httpd.conf is blank <br>
>  /etc/apache2/ports.conf is follow

	NameVirtualHost *:80
	Listen 80
	
	<IfModule mod_ssl.c>
	    Listen 443
	</IfModule>
	
	<IfModule mod_gnutls.c>
	    Listen 443
	</IfModule>

**Apache knowledge**

>htcacheclean - 清理磁盘缓冲区

### Nginx

> sudo apt-get install nginx

**/usr/local/nginx/conf/nginx.conf** : cannot show dynamic graph

	#user  nobody;
	worker_processes  1;
	error_log  logs/error.log  info;
	pid        logs/nginx.pid;
	
	events {
	    worker_connections  1024;
	}
	
	http {
	    include       mime.types;
	    default_type  application/octet-stream;
	    #access_log  logs/access.log  main;
	    sendfile        on;
	    #tcp_nopush     on;
	    keepalive_timeout  65;
	    #gzip  on;
	
	    server {
	            listen       80;
	            server_name  localhost;
	
	            #charset koi8-r;
	            #access_log  logs/host.access.log  main;
	
			    location / {
			        root   html;
			        index  index.html index.htm;
			    }
	
			    location ^~ /munin/ {
				alias /var/cache/munin/www/;
				index index.html index.htm index.php;
			    }
	
	            error_page  404              /404.html;
	            # redirect server error pages to the static page /50x.html
	            error_page   500 502 503 504  /50x.html;
	            location = /50x.html {
	                root   html;
	            }
	
	        }
	}

### start munin monitor

> use htop to see progress list  ------ > htop

#### Nginx server
> my nginx location : /usr/local/nginx

	sudo service munin-node start   
	sudo service munin start 
	sudo /usr/local/nginx/sbin/nginx
    ...
    ...
	sudo /usr/local/nginx/sbin/nginx -s signal (stop, quit, reopen, reload)
    # sudo kill -XXX `cat /usr/local/nginx/logs/nginx.pid`
    

#### Apache2 server

    sudo service munin-node start
    sudo service munin start
    sudo service apache2 start
    ...
    ...
    sudo service *** stop

### Munin parameters analysis


#### knowledge

Filedname type: their difference refer to the blog : *http://blog.liuts.com/post/215/*

**Gauge** : is for things like temperatures or number of people in a room or the value of a RedHat? share. GAUGE is the default.

**COUNTER** : is for continuous incrementing counters like the ifInOctets counter in a router. The COUNTER data source assumes that the counter never decreases, except when a counter overflows. The update function takes the overflow into account. The counter is stored as a per-second rate. When the counter overflows, RRDtool checks if the overflow happened at the 32bit or 64bit border and acts accordingly by adding an appropriate value to the result.

**DERIVE** : will store the derivative of the line going from the last to the current value of the data source. This can be useful for gauges, for example, to measure the rate of people entering or leaving a room. Internally, derive works exactly like COUNTER but without overflow checks. So if your counter does not reset at 32 or 64 bit you might want to use DERIVE and combine it with a MIN value of 0.

**ABSOLUTE** : is for counters which get reset upon reading. This is used for fast counters which tend to overflow. So instead of reading them normally you reset them after every read to make sure you have a maximum time available before the next overflow. Another usage is for things you count like number of messages since the last update.

Network Packets : Common packets structure length is 46~1500 bytes , refer to http://bdxnote.blog.163.com/blog/static/8444235200811575426843/

----------

**disk**

    Disk IOs per device : Units read (-) / write (+)
    Disk latency per device : seconds 
    Disk usage in percent : %
    Inode usage in percent : %
    Throughput per device : bytes pr ${graph_period} read (-) / write (+)
    Disk utilization per device : % busy
	Inode usage in percent : %
	IO Service time : seconds
	IOstat : blocks per second read (-) / written (+)

**network**

	eth0 errors : Packets in (-) / out (+) per second
	eth0 traffic : bits in (-) / out (+) per second
	Firewall Throughput : Packets/second
	HTTP loadtime of a page : Load time in seconds

**nfs**

	NFS Client : requests / second
	NFS Server : requests / second
	NFSv4 Client : requests / second
	NFSv4 Server : requests / second

**postfix**

	Postfix bytes throughput : bytes / second
	Postfix Mailqueue : Mails in queue

**printing**

	Print queues

**processes**

	Fork rate : forks / second
	Number of threads : Number of threads
	Processes : Number of processes
	Processes priority : Number of processes
	VMstat : process states

**system**

	Available entropy : entropy (bytes)
	CPU usage : %
	File table usage : number of open files
	Individual interrupts : interrupts / second
	Inode table usage : number of open inodes
	Interrupts and context switches : Interrupt&context switches / second
	Load average : load
	Memory usage : Bytes
	Swap in/out : pages per second in (-) / out (+)
	Uptime : uptime is days

**diskstats_iops**

	disk
		Disk IOs for /dev/sda ： Unite read (-) / write (+)
		Disk IOs for /dev/sdb 
		Disk IOs for /dev/sdc

**diskstats_latency**

	disk
		Disk latency for /dev/sda : seconds
		Disk latency for /dev/sdb
		Disk latency for /dev/sdc

**diskstats_throughput**

	disk
		Disk throughput for /dev/sda : Bytes/second read (-) / write (+)
		Disk throughput for /dev/sdb
		Disk throughput for /dev/sdc

**diskstats_utilization**

	disk
		Disk utilization for /dev/sda : Percent
		Disk utilization for /dev/sdb
		Disk utilization for /dev/sdc
